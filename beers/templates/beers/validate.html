{% extends 'base/base.html' %}
{% load staticfiles %}

{% block title %}
  Validate Checkins
{% endblock %}

{% block scripts %}
  <script type="text/javascript" src="{% static 'jquery/dist/jquery.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js-cookie/src/js.cookie.js' %}"></script>
  {{ form.media }}
  <script>
  function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  }
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      var csrftoken = Cookies.get('csrftoken');
      if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    }
  });
  </script>
  <script>
  (function(exports) {
    var currentSearch = -1;
    var currentResult = -1;

    function sendContent(uvId, content) {
      var url = "{% url 'update-checkin' contest.id 0 %}";
      url = url.replace('/0/', '/' + uvId + '/');
      $.ajax({
        url: url,
        headers: {
          Accept: 'application/json'
        },
        data: JSON.stringify(content),
        contentType: 'application/json',
        dataType: 'json',
        method: 'POST'
      }).done(function (result, status, xhr) {
          console.log('Status: ' + status);
          if (status == "success") {
            $('#id_'+uvId+'_vbutton').fadeOut(400).remove();
            $('#id_'+uvId+'_dbutton').fadeOut(400).remove();
            $('#id_'+uvId+'_select').prop('disabled', true);
            {% comment %}
            if (currentSearch == uvId) {
              exports.clearSearchBox();
            }
            $('#id_'+uvId+'_box').fadeOut(400, function() {
              $('#id_'+uvId+'_box').slideUp(2000, function() {
                $('#id_'+uvId+'_box').remove();
              })
            });
            {% endcomment %}
          } else {
            alert("Got an error " + status);
          }
        }
      ).fail(function (xhr, status, error) {
        alert("Error trying to send content: " + content + ": " + error)
      });
    }

    exports.data = [
      {% for b in beers %}{ id: {{ b.id }}, text: '{{ b.beer_name }}'},
      {% endfor %}
    ];

    exports.dismissUv = function(uvId) {
      sendContent(uvId, {'remove-beer': 'Remove'});
      console.log('Dismissing ' + uvId);
    }

    exports.validateUv = function(uvId, beerId) {
      sendContent(uvId, { 'validate-beer': 'Validate', 'contest-beer': beerId});
      console.log('Setting ' + uvId + ' to beer ' + beerId);
    }

  })(this.uvPage = {});

  $(document).ready(function() {
    /* Convert to select2 for dropdown */
    $(".beer-list").select2({ placeholder: "Select a beer", allowClear: true, data: uvPage.data, })
    /* When a beer is selected, enable validation */
    $(".beer-list").on("select2:select", function (e) {
        $(this).parents(".validation-row").find(".validation-click").prop('disabled', false);
      }
    );
    /* When a beer is unselected, disable validation */
    $(".beer-list").on("select2:unselect", function (e) {
        $(this).parents(".validation-row").find(".validation-click").prop('disabled', true);
      }
    );
    /* When a validate button is clicked, submit the validation information */
    $(".validation-click").click(function () {
      // The parent validation-row contains the validation ID in its data
      var row = $(this).parents(".validation-row");
      var uvId = $(row).data("validationId");
      var selected = $(row).find(".beer-list option:selected").val();
      if (selected) {
        uvPage.validateUv(uvId, selected);
      }
    });
    /* When a dismissal is clicked, submit the dismissal information */
    $(".dismissal-click").click(function () {
      // The parent validation-row contains the validation ID in its data
      console.log("Attempting dismissal on " + $(this).text())
      var uvId = $(this).parents(".validation-row").data("validationId");
      console.log("Found uvId " + uvId);
      uvPage.dismissUv(uvId);
    });
  });
  </script>
{% endblock %}

{% block content %}
  <div class="validations">
    <table id="validation-table">
      <tr>
        <th>Player</th>
        <th>Beer/Brewery Checkin</th>
        <th>Checkin Date</th>
        <th>Select Contest Beer</th>
        <th>Validate</th>
        <th>Dismiss</th>
      </tr>
      {% for uv in uvs %}
      <tr class="validation-row" id="id_{{ uv.id }}_row" data-validation-id="{{ uv.id }}">
        <td>
          {{ uv.contest_player.player.user.username }}
        </td>
        <td>
          <a href="{{ uv.untappd_checkin }}" target="_blank">
            {{ uv.beer }} from {{ uv.brewery }}
          </a>
        </td>
        <td>
          {{ uv.untappd_checkin_date|date:"SHORT_DATE_FORMAT" }}
        </td>
        <td>
          <select id="id_{{ uv.id }}_select" class="beer-list">
            {% if uv.possible %}
            <option value="{{ uv.possible.id }}">{{ uv.possible.beer_name }}</option>
            {% else %}
            <option></option>
            {% endif %}
          </select>
        </td>
        <td>
          <button id="id_{{ uv.id }}_vbutton" class="validation-button validation-click" {% if not uv.possible %}disabled{% endif %}>
            Validate
          </button>
        </td>
        <td>
          <button id="id_{{ uv.id }}_dbutton" class="validation-button dismissal-click">
            Dismiss
          </button>
        </td>
      </tr>
      {% endfor %}
    </table>
    <div class="pager">
      <span class="step-links">
        {% if uvs.has_previous %}
          <a href="?page={{ uvs.previous_page_number }}">previous</a>
        {% endif %}

        <span class="current">
          Page {{ uvs.number }} of {{ uvs.paginator.num_pages }}.
        </span>

        {% if uvs.has_next %}
          <a href="?page={{ uvs.next_page_number }}">next</a>
        {% endif %}
      </span>
    </div>
  </div>


<div class="dialog-overlay" id="validation-dialog">
  <div class="dialog-box">
    <span id="dialog-text">
    </span>
  </div>
</div>

<div class="dialog-overlay" id="ignore-dialog">
  <div class="dialog-box">
    <span id="dialog-text">
    </span>
  </div>
</div>

{% endblock %}
